# Snippets

![Version](https://img.shields.io/badge/version-1.1.0-28A5F5.svg?style=for-the-badge)
![Last Update](https://img.shields.io/badge/last_update-2019.08.16-28A5F5.svg?style=for-the-badge)
![Joomla](https://img.shields.io/badge/joomla-3.9+-1A3867.svg?style=for-the-badge)
![Php](https://img.shields.io/badge/php-5.6+-8892BF.svg?style=for-the-badge)

**Пакет расширений, обеспечивающий использование в контенте сайта шорткодов-сниппетов, с возможностью импекса данных посредством внешних плагинов.**

## Использование в контенте сайта

`{snippet [name|id]}`, где:

- **snippet** — зарезервированное слово
- **name** — имя сниппета
- **id** — идентификатор сниппта в системе

## Описание основных составляющих пакета расширений

Компонент сниппетов позволяет учитывать снипеты и их контент, производить операции по импексу (импорту и экспорту) данных. Каждый сниппет состоит из наименования и его контента. Сниппет имеет статус публикации.

Имя сниппета должно состоять из символов латинского алфавита в нижнем регистре, цифр и символа нижнего подчеркивания `_`. При несоотвествии имени оно будет автоматически преобразовано при сохранении сниппета либо при его импорте.

Контент сниппета поддерживает полноценный HTML.

Компонент поддерживает поиск сниппета по его id и/или наименованию.

Системный плагин снипптов обеспечивает замену шорткодов на их контент. Необработанные шорткоды вырезаются из контента. **Неопубликованные сниппеты не обрабатываются!**

Плагин – кнопка для редактора позволяет выбрать сниппет в при редактировании контента и вставить в выделенное место готовый шорткод.

## Импекс данных

Импекс данных производится посредством плагинов группы `snippetimpex`. В базовый состав пакета включены плагины для импекса с форматами CSV и JSON. Компонент отображает только опубликованные плагины. На экспорт передаются все данные, в т.ч. неопубликованные.

Компонент имеет 2 настройки для работы плагинов импекса, влияющие исключительно на экспорт.

**Сохранять файл на сервере** — указывает, хранить ли файлы с экспортированными данными на сервере постоянно, по умолчанию имеет значение _да_.

**Папка сохранения** — позволяет выбрать папку, где именно будут хранится файлы экспорта данных, по умолчанию это папка `/files` в корне сайта — она создаётся автоматически при усрановке пакета, со стандартными правами 0755. Если папка не указана — задействуется папка временных файлов Joomla!, если указанная папка не найдена — задействуется папка временных файлов Joomla!, если параметр **Сохранять файл на сервере** имеет значение _нет_ — задействуется папка временных файлов Joomla!, при этом после скачивания сформированного файла файл удаляется.

При импорте файлов данных они временно сохраняются в папку временных файлов Joomla! и после успешного импорта удаляются с сервера.

---

### Для разработчиков

Каждый плагин реализует 2 события.

#### Структура данных

Передаваемые в плагин для экспорта и принимаемые от плагина для импорта данные имеют готовую законченную форму в виде ассоуиированного массива, где ключ — наименование сниппета, значение ключа — либо строка контента, либо ассоциированный масссив из двух элементов: `content` => значение контента, являющееся строкой; `descript` => описание сниппета, являющееся строкой. Иные вложенные массивы и объекты в виде контента недопускаются. Совпадающие ключи недопускаются по определению ассоциированных массивов.

Перобразование имени сниппета в необходимый для работы системы вид занимается контроллер компонента, плагину заботиться об этом не обязательно, но рекомендуется.

При экспорте данных экранированием контента плагин занимается самостоятельно.

При импорте данных в случае содержания контентом html-тегов плагин самостоятельно декодирует их при необходимости.

#### Экспорт

```php
public function onSnippetDataExport((string)$type, (string)$path, (array)$data): (object)stdClass
```

`(string)$type` — тип данных, выбранный для экспорта, совпадает с именем плагина, при несовпадении плагин не должен производитьобработку данных.

`(string)$path` — полный путь к папке на сервере, куда необходимо записать файл; при отсутствии пути произвести сохранение в папку временных файлов Joomla!; не содержит имя сохраняемого файла — плагин должен сформировать его самостоятельно.

`(array)$data)` — массив данных, предназначенных для экспорта.

Плагин возвращает структуру в виде стандартного объекта, где следующие поля должны иметь следующие значения:

- `(bool)$result` – показатель успешности работы плагина
- `(string)$type` — тип данных, с которыми работает плагин, всегда совпадает с именем плагина
- `(string)$message` — сообщение о работе плагина, при пустом значении означает, что плагин не производил никаких действий по экспорту данных
- `(string)$file` — полный путь к результирующему файлу, может отсутствовать при неудачном результате работы плагина

#### Импорт

```php
public function onSnippetDataImport((string)$file): (object)stdClass
```

`(string)$file` — полный путь к файлу на сервере, откуда необходимо прочитать данные для последующей обработки.

Плагин возвращает структуру в виде стандартного объекта, где следующие поля должны иметь следующие значения:

- `(bool)$result` – показатель успешности работы плагина
- `(string)$type` — тип данных, с которыми работает плагин, всегда совпадает с именем плагина
- `(string)$message` — сообщение о работе плагина, при пустом значении означает, что плагин не производил никаких действий по экспорту данных
- `(array)$data` — массив данных для последующего импорта (описан выше), может отсутствовать при неудачном результате работы плагина

#### Плагин не берёт на себя работу по чтению данных сниппетов из БД или записи данных сниппетов в БД — эту работу выполняет контроллер компонента. Всё, что делает плагин — читает и записывает файлы, передаёт и получает массив данных. Всё.
